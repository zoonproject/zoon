<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Building modules. zoon</title><!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous"><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <div class="container">
      <header><div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">zoon</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../index.html">Home</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/zoonproject/zoon">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->
      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Building modules</h1>
                        <h4 class="author">Tom August &amp; Tim Lucas</h4>
            
            <h4 class="date">2016-08-22</h4>
          </div>

    
    
<div id="the-1-2-3-of-module-building" class="section level2">
<h2>The &ldquo;1, 2, 3&rdquo; of module building</h2>
<p>The process of making a module is essentially</p>
<ol style="list-style-type: decimal"><li>Write an R function</li>
<li>Run <code>BuildModule</code> with the function and metadata</li>
<li><em>Optional</em> &ndash; Upload to the zoon modules repository</li>
</ol><p>Each module type is slightly different to write though the same three basic steps apply. Below we show an example of how to write each of the module types. We also link to pre-existing modules that you can use as templates.</p>
</div>
<div id="how-to-build-an-occurrence-module" class="section level2">
<h2>How to build an occurrence module</h2>
<p>The aim of an occurrence module is to return a data.frame of occurrence data which can be used for modelling a species distribution. The example I&rsquo;m going to show gets data from a fictional survey we have undertaken. The data was saved as a .csv and to share it we have placed it on Figshare.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Load zoon</span>
<span class="kw">library</span>(zoon)

<span class="co"># Start building our function</span>
Lorem_ipsum_UK &lt;-<span class="st"> </span>function(){</code></pre></div>
<p>In this case we have not given our function any arguments as we simply want to return the online dataset. However you could add arguments here to modify what your function returns (for an example <a href="https://github.com/zoonproject/modules/blob/master/R/SpOcc.R">see the SpOcc module</a>).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># First I retrieve the data from figshare</span>
<span class="co"># Here is the URL</span>
URL &lt;-<span class="st"> "https://ndownloader.figshare.com/files/2519918"</span>

<span class="co"># Here is the data</span>
out &lt;-<span class="st"> </span><span class="kw">read.csv</span>(URL)
<span class="kw">head</span>(out)</code></pre></div>
<pre><code>##    startDate latitude longitude
## 1 2014-06-25 51.98917 0.8917427
## 2 2014-06-25 51.98917 0.8917427
## 3 2007-08-28 52.21136 0.6602159
## 4       &lt;NA&gt; 51.97564 0.9833449
## 5 1973-01-01 52.34187 0.7142953
## 6 2013-04-12 52.23719 0.7877316</code></pre>
<p>Now it is time to think about how we return our data. The output format for occurrence modules is very important. If you do not ensure that the format is correct then your module will not work properly when entered into a workflow. An occurrence module must return a data.frame with the columns longitude, latitude, value, type and fold, the details are given at <a href="#occIO">the end of this document</a>. The order of these columns is important.</p>
<p>Our occurrence data does not have all of these columns so we need to add them. So we need to do a little reformatting</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Keep only Lat Long columns</span>
out &lt;-<span class="st"> </span>out[, <span class="kw">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>)]

<span class="co"># Add in the columns we dont have</span>
out$value &lt;-<span class="st"> </span><span class="dv">1</span> <span class="co"># all our data are presences</span>
out$type &lt;-<span class="st"> 'presence'</span>
out$fold &lt;-<span class="st"> </span><span class="dv">1</span> <span class="co"># we don't add any folds</span>

<span class="co"># Now the data is in the correct format we can return it</span>
<span class="kw">return</span>(out)</code></pre></div>
<p>We have now written the R code for our occurrence module, this is what it looks like when you put it all together.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Lorem_ipsum_UK &lt;-<span class="st"> </span>function(){
  
  <span class="co"># Get data</span>
  URL &lt;-<span class="st"> "https://ndownloader.figshare.com/files/2519918"</span>
  out &lt;-<span class="st"> </span><span class="kw">read.csv</span>(URL)
  out &lt;-<span class="st"> </span>out[, <span class="kw">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>)]
  
  <span class="co"># Add in the columns we dont have</span>
  out$value &lt;-<span class="st"> </span><span class="dv">1</span> <span class="co"># all our data are presences</span>
  out$type &lt;-<span class="st"> 'presence'</span>
  out$fold &lt;-<span class="st"> </span><span class="dv">1</span> <span class="co"># we wont add any folds</span>
  
  <span class="kw">return</span>(out)
}</code></pre></div>
<p>Now that we have our function written we can test it very simply in a workflow like this.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">workl1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/workflow.html">workflow</a></span>(<span class="dt">occurrence =</span> Lorem_ipsum_UK,
                   <span class="dt">covariate =</span> UKBioclim,
                   <span class="dt">process =</span> OneHundredBackground,
                   <span class="dt">model =</span> LogisticRegression,
                   <span class="dt">output =</span> PrintMap)</code></pre></div>
<p><img src="/Users/nick/Dropbox/Github/zoon/vignettes/building_occ6-1.png" title="plot of chunk building_occ6" alt="plot of chunk building_occ6" style="display:block; margin: auto"></p>
<p>This is a nice way to debug your function and ensure you are getting the results you expect.</p>
<p>Once you are happy that your function is working as you expect it to you can build you code into a module using the <code>BuildModule</code> function in <code>zoon</code>. This script adds in metadata including the type of module, authors&rsquo; names, a brief description and documentation for the arguments it accepts (though this one doesn&rsquo;t accept any arguments). Once <code>BuildModule</code> has created your module it will run it through checks to make sure has the required features, outputs data in the correct format, etc. Checking can be turned off by setting the argument <code>check = FALSE</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Let's build our module</span>
<span class="kw"><a href="../reference/BuildModule.html">BuildModule</a></span>(Lorem_ipsum_UK,
            <span class="dt">type =</span> <span class="st">'occurrence'</span>,
            <span class="dt">title =</span> <span class="st">'A dataset of Lorem ipsum occurrences'</span>,
            <span class="dt">description =</span> <span class="kw">paste0</span>(<span class="st">'The module retrieves a dataset of'</span>,
            <span class="st">'Lorem ipsum records from figshare. This dataset contains'</span>,
            <span class="st">'precence only data and was collected between 1990 and'</span>,
            <span class="st">'2000 by members of to Lorem ipsum appreciation society'</span>),
            <span class="dt">details =</span> <span class="st">'This dataset is fake, Lorem ipsum does not exist'</span>,
            <span class="dt">version =</span> <span class="fl">0.1</span>,
            <span class="dt">author =</span> <span class="st">'A.B. Ceidi'</span>,
            <span class="dt">email =</span> <span class="st">'ABCD@anemail.com'</span>,
            <span class="dt">dataType =</span> <span class="st">'presence-only'</span>)</code></pre></div>
<pre><code>## Starting checks...</code></pre>
<pre><code>## done</code></pre>
<pre><code>## [1] "Lorem_ipsum_UK"</code></pre>
<p>This function is fairly self explanatory however it is worth noting the <code>dataType</code> field. This must be any of &lsquo;presence-only&rsquo;, &lsquo;presence/absence&rsquo;, &lsquo;presence/background&rsquo;, &lsquo;abundance&rsquo; or &lsquo;proportion&rsquo;. This is important so that people using your module in the future will know what it is going to output.</p>
<p><code>BuildModule</code> has now written an R file in our working directory containing the function and metadata, so that it can be shared with others.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># First we remove the function from our workspace</span>
<span class="kw">rm</span>(<span class="dt">list =</span> <span class="st">'Lorem_ipsum_UK'</span>)

<span class="co"># This is how you would use a module that a colleague has sent you</span>
<span class="kw"><a href="../reference/LoadModule.html">LoadModule</a></span>(<span class="dt">module =</span> <span class="st">'Lorem_ipsum_UK.R'</span>)

work2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/workflow.html">workflow</a></span>(<span class="dt">occurrence =</span> Lorem_ipsum_UK,
                  <span class="dt">covariate =</span> UKAir,
                  <span class="dt">process =</span> OneHundredBackground,
                  <span class="dt">model =</span> LogisticRegression,
                  <span class="dt">output =</span> PrintMap)</code></pre></div>
<p>Once we&rsquo;re happy with the module, we will hopefully upload it to the zoon repository. The repository is currently under development. Visit <a href="https://zoonproject.wordpress.com/">the development pages</a> for more information.</p>
</div>
<div id="how-to-write-a-covariate-module" class="section level2">
<h2>How to write a covariate module</h2>
<p>The aim of a covariate module is to provide spatial information that will help to explain the distribution of a species. For example this data could be climate data, habitat data or topology.</p>
<p>A covariate module, like an occurrence module, does not have to take any arguments but must return a raster layer, brick or stack.</p>
<p>In this example we will create a covariate module that can provide a number of different climate layers for the area covering Australia.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Our function will take an argument to set the variable</span>
<span class="co"># the user wants returned</span>
AustraliaAir &lt;-<span class="st"> </span>function(<span class="dt">variable =</span> <span class="st">'rhum'</span>){</code></pre></div>
<p>When your module has arguments, as here, it is important to include defaults for all arguments. This make it easier for other users to use your modules and allows your module to be tested effectively when you upload it to the zoon repository.</p>
<p>The first step is to load the R packages that your code is going to need. It is important that you use the <code>GetPackage</code> function rather than <code>library</code> or <code>require</code> as it will also install the package if the user does not already have it installed.</p>
<p>In this example we do not need any external packages as the data we are downloading is a RasterStack object, and zoon already loads the <code>raster</code> package to deal with RasterStacks.</p>
<p>To share our covariate data we have saved the raster object as an R data file and <a href="http://figshare.com/articles/NCEP_Australia/1610215">placed it on Figshare</a> - attributing those that created the data.</p>
<p>In our module we download this data into R</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Load in the data</span>
URL &lt;-<span class="st"> "http://files.figshare.com/2527274/aus_air.rdata"</span>
<span class="kw">load</span>(<span class="kw">url</span>(URL, <span class="dt">method =</span> <span class="st">'libcurl'</span>)) <span class="co"># The object is called 'ras'</span>

<span class="co"># Subset the data according the the variable parameter</span>
ras &lt;-<span class="st"> </span><span class="kw">subset</span>(ras, variables)

<span class="kw">return</span>(ras)</code></pre></div>
<p>We can test our function works by running it in a workflow with other modules</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">AustraliaAir &lt;-<span class="st"> </span>function(<span class="dt">variables =</span> <span class="st">'rhum'</span>){

  URL &lt;-<span class="st"> "http://files.figshare.com/2527274/aus_air.rdata"</span>
  <span class="kw">load</span>(<span class="kw">url</span>(URL, <span class="dt">method =</span> <span class="st">'libcurl'</span>)) <span class="co"># The object is called 'ras'</span>
  ras &lt;-<span class="st"> </span><span class="kw">subset</span>(ras, variables)
  <span class="kw">return</span>(ras)
  
}

<span class="co"># Select the variables we want</span>
myVariables &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">'air'</span>,<span class="st">'hgt'</span>,<span class="st">'rhum'</span>,<span class="st">'shum'</span>,<span class="st">'omega'</span>,<span class="st">'uwnd'</span>,<span class="st">'vwnd'</span>)

work3 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/workflow.html">workflow</a></span>(<span class="dt">occurrence =</span> <span class="kw">SpOcc</span>(<span class="dt">extent =</span> <span class="kw">c</span>(<span class="dv">111</span>, <span class="dv">157</span>, -<span class="dv">46</span>, -<span class="dv">6</span>),
                                     <span class="dt">species =</span> <span class="st">'Varanus varius'</span>,
                                     <span class="dt">limit =</span> <span class="dv">500</span>),
                  <span class="dt">covariate =</span> <span class="kw">AustraliaAir</span>(<span class="dt">variables =</span> myVariables),
                  <span class="dt">process =</span> OneHundredBackground,
                  <span class="dt">model =</span> LogisticRegression,
                  <span class="dt">output =</span> PrintMap)</code></pre></div>
<p><img src="/Users/nick/Dropbox/Github/zoon/vignettes/building_cov4-1.png" title="plot of chunk building_cov4" alt="plot of chunk building_cov4" style="display:block; margin: auto"></p>
<p>Once we are happy with the function we have written we need to use the <code>BuildModule</code> function to convert our function into a module by adding in the necessary metadata. Once <code>BuildModule</code> has created your module it will run it through checks to make sure has the required features, outputs data in the correct format, etc. Checking can be turned off by setting the argument <code>check = FALSE</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Build our module</span>
<span class="kw"><a href="../reference/BuildModule.html">BuildModule</a></span>(AustraliaAir,
            <span class="dt">type =</span> <span class="st">'covariate'</span>,
            <span class="dt">title =</span> <span class="st">'Australia Air data from NCEP'</span>,
            <span class="dt">description =</span> <span class="kw">paste</span>(<span class="st">'This modules provides access to the'</span>,
                                <span class="st">'NCEP air data for austrlia provided by'</span>,
                                <span class="st">'NCEP and should be attributed to Climatic'</span>,
                                <span class="st">'Research Unit, University of East Anglia'</span>),
            <span class="dt">details =</span> <span class="kw">paste</span>(<span class="st">'These data are redistributed under the terms of'</span>,
                            <span class="st">'the Open Database License'</span>,
                            <span class="st">'http://opendatacommons.org/licenses/odbl/1.0/'</span>),
            <span class="dt">version =</span> <span class="fl">0.1</span>,
            <span class="dt">author =</span> <span class="st">'Z.O. Onn'</span>,
            <span class="dt">email =</span> <span class="st">'zoon@zoon-zoon.com'</span>,
            <span class="dt">paras =</span> <span class="kw">list</span>(<span class="dt">variables =</span> <span class="kw">paste</span>(<span class="st">'A character vector of air variables'</span>,
                         <span class="st">'you wish to return. This can include any number of'</span>,
                         <span class="st">"the following: 'air','hgt','rhum','shum','omega',"</span>,
                         <span class="st">"'uwnd','vwnd'"</span>)))</code></pre></div>
<pre><code>## Starting checks...</code></pre>
<pre><code>## done</code></pre>
<pre><code>## [1] "AustraliaAir"</code></pre>
<p><code>BuildModule</code> is fairly self explanatory but it is worth noting the <code>paras</code> argument. This takes a named list of the parameters the module takes. This should follow the following structure; <em>list(parameterName = &lsquo;Parameter description.&rsquo;, anotherParameter = &lsquo;Another description.&rsquo;)</em></p>
<p>Once <code>BuildModule</code> has been run there will be an R file in our working directory that represents our module and can be shared with others. This R script can be used as follows.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># remove the original function from our environment</span>
<span class="kw">rm</span>(<span class="dt">list =</span> <span class="st">'AustraliaAir'</span>)

<span class="co"># Load the module script</span>
<span class="kw"><a href="../reference/LoadModule.html">LoadModule</a></span>(<span class="st">'AustraliaAir.R'</span>)

work4 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/workflow.html">workflow</a></span>(<span class="dt">occurrence =</span> <span class="kw">SpOcc</span>(<span class="dt">extent =</span> <span class="kw">c</span>(<span class="dv">111</span>, <span class="dv">157</span>, -<span class="dv">46</span>, -<span class="dv">6</span>),
                                     <span class="dt">species =</span> <span class="st">'Varanus varius'</span>,
                                     <span class="dt">limit =</span> <span class="dv">500</span>),
                  <span class="dt">covariate =</span> AustraliaAir,
                  <span class="dt">process =</span> OneHundredBackground,
                  <span class="dt">model =</span> LogisticRegression,
                  <span class="dt">output =</span> PrintMap)</code></pre></div>
<p>Once we&rsquo;re happy with the module, we will hopefully upload it to the zoon repository. The repository is currently under development. Visit <a href="https://zoonproject.wordpress.com/">the development pages</a> for more information.</p>
</div>
<div id="how-to-write-a-process-module" class="section level2">
<h2>How to write a process module</h2>
<p>The aim of a process model is to modify the occurrence data or/and the covariate data prior to modelling. Examples include adding background points, or adding folds for cross-validation.</p>
<p>A process model returns data in exactly the same format that it accepts data. It takes and returns a list of two elements. The first element is a data.frame with the columns values, type, fold, longitude, latitude (<a href="#occIO">see Occurrence module output</a>), and additional covariate columns. The covariate columns are added internally in the zoon workflow by combining the output of the covariate module. The data.frame has an attribute <code>covCols</code> which details which columns these are. The second element of the list is a RasterBrick, RasterLayer, or RasterStack as returned by a covariate module.</p>
<p>In this example we are going to create a process module that cuts down our occurrence data to a user supplied extent.</p>
<p>When writing a module it is useful to have example input to test with. One way to do this is to run a similar workflow and use the outputs of that workflow to test yours. Here is an example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># We run a very simple workflow so that we can get example input</span>
<span class="co"># for our module</span>
work5 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/workflow.html">workflow</a></span>(<span class="dt">occurrence =</span> UKAnophelesPlumbeus,
                  <span class="dt">covariate  =</span> UKAir,
                  <span class="dt">process    =</span> OneHundredBackground,
                  <span class="dt">model      =</span> LogisticRegression,
                  <span class="dt">output     =</span> PrintMap)</code></pre></div>
<p><img src="/Users/nick/Dropbox/Github/zoon/vignettes/building_pro1-1.png" title="plot of chunk building_pro1" alt="plot of chunk building_pro1" style="display:block; margin: auto"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># The output from a process module is in the same format as the </span>
<span class="co"># input, so we can use the output of OneHundredBackground as the testing</span>
<span class="co"># input for our module. Note that this object should be called</span>
<span class="co"># .data</span>
.data &lt;-<span class="st"> </span><span class="kw"><a href="../reference/Occurrence.html">Process</a></span>(work5)

<span class="kw">str</span>(.data, <span class="dv">2</span>)</code></pre></div>
<pre><code>## List of 2
##  $ df :'data.frame': 269 obs. of  6 variables:
##   ..$ value    : num [1:269] 1 1 1 1 1 1 1 1 1 1 ...
##   ..$ type     : Factor w/ 2 levels "background","presence": 2 2 2 2 2 2 2 2 2 2 ...
##   ..$ fold     : num [1:269] 1 1 1 1 1 1 1 1 1 1 ...
##   ..$ longitude: num [1:269] 1.01 -0.16 -2.83 -0.63 -3.53 ...
##   ..$ latitude : num [1:269] 52.4 51.6 53.4 51.6 56 ...
##   ..$ layer    : num [1:269] 271 272 272 272 271 ...
##   ..- attr(*, "covCols")= chr "layer"
##  $ ras:Formal class 'RasterLayer' [package "raster"] with 12 slots
##  - attr(*, "call_path")=List of 3
##   ..$ occurrence: chr "UKAnophelesPlumbeus"
##   ..$ covariate : chr "UKAir"
##   ..$ process   : chr "OneHundredBackground"</code></pre>
<p>It is important to note that the list object that is passed into a process module is named <code>.data</code>, and so when writing our module we need to adhere to this convention.</p>
<p>First lets have a look at the input</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># The first element is the occurrence data</span>
<span class="kw">head</span>(.data$df)</code></pre></div>
<pre><code>##   value     type fold   longitude latitude    layer
## 1     1 presence    1  1.01287600 52.37696 271.4658
## 2     1 presence    1 -0.16003467 51.57146 272.2655
## 3     1 presence    1 -2.83497900 53.40813 271.6481
## 4     1 presence    1 -0.62955210 51.55540 272.2655
## 5     1 presence    1 -3.52534680 56.04848 271.2964
## 6     1 presence    1  0.01144066 51.58168 272.2655</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># The attribute covCols gives the covariate columns</span>
<span class="kw">attr</span>(.data$df, <span class="st">'covCols'</span>)</code></pre></div>
<pre><code>## [1] "layer"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># If we want to modify these covariate columns in</span>
<span class="co"># our process module we can select them using this</span>
<span class="co"># attribute</span>
<span class="kw">head</span>(.data$df[<span class="kw">attr</span>(.data$df, <span class="st">'covCols'</span>)])</code></pre></div>
<pre><code>##      layer
## 1 271.4658
## 2 272.2655
## 3 271.6481
## 4 272.2655
## 5 271.2964
## 6 272.2655</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># The second element is the raster</span>
<span class="kw">plot</span>(.data$ras)</code></pre></div>
<p><img src="/Users/nick/Dropbox/Github/zoon/vignettes/buliding_pro1a-1.png" title="plot of chunk buliding_pro1a" alt="plot of chunk buliding_pro1a" style="display:block; margin: auto"></p>
<p>Let&rsquo;s start writing our new process module.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Start writing our module</span>
ClipOccurence &lt;-<span class="st"> </span>function(.data, <span class="dt">extent =</span> <span class="kw">c</span>(-<span class="dv">180</span>, <span class="dv">180</span>, -<span class="dv">180</span>, <span class="dv">180</span>)){</code></pre></div>
<p>Here we have remembered to give <code>.data</code> as an argument as this is a <a href="#proIO">default for process modules</a>. In addition we have supplied an argument for the extent and set the default to the entire globe (i.e.&nbsp;no clipping). It is important that all of your arguments have defaults (even if the default might not be a good idea in practice), as this allows the zoon system to perform automatic testing on your modules when you share them online.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Write the body of our function</span>
<span class="co"># extract the occurrence data from the .data object</span>
occDF &lt;-<span class="st"> </span>.data$df

<span class="co"># Subset by longitude</span>
occSub &lt;-<span class="st"> </span>occDF[occDF$longitude &gt;=<span class="st"> </span>extent[<span class="dv">1</span>] &amp;
<span class="st">                </span>occDF$longitude &lt;=<span class="st"> </span>extent[<span class="dv">2</span>], ]

<span class="co"># Subset by latitude</span>
occSub &lt;-<span class="st"> </span>occSub[occSub$latitude &gt;=<span class="st"> </span>extent[<span class="dv">3</span>] &amp;
<span class="st">                 </span>occSub$latitude &lt;=<span class="st"> </span>extent[<span class="dv">4</span>], ]

<span class="co"># assign this data.frame back to the .data object</span>
.data$df &lt;-<span class="st"> </span>occSub</code></pre></div>
<p>So our simple process function looks like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ClipOccurrence &lt;-<span class="st"> </span>function(.data, <span class="dt">extent =</span> <span class="kw">c</span>(-<span class="dv">180</span>, <span class="dv">180</span>, -<span class="dv">180</span>, <span class="dv">180</span>)){
  
  <span class="co"># Write the body of our function</span>
  <span class="co"># extract the occurrence data from the .data object</span>
  occDF &lt;-<span class="st"> </span>.data$df
  
  occSub &lt;-<span class="st"> </span>occDF[occDF$longitude &gt;=<span class="st"> </span>extent[<span class="dv">1</span>] &amp;
<span class="st">                  </span>occDF$longitude &lt;=<span class="st"> </span>extent[<span class="dv">2</span>], ]
 
  occSub &lt;-<span class="st"> </span>occSub[occSub$latitude &gt;=<span class="st"> </span>extent[<span class="dv">3</span>] &amp;
<span class="st">                   </span>occSub$latitude &lt;=<span class="st"> </span>extent[<span class="dv">4</span>], ]
  
  .data$df &lt;-<span class="st"> </span>occSub
  
  <span class="kw">return</span>(.data)
  
}</code></pre></div>
<p>Our next step is to test that this function will work in a workflow. Once we have read in our function so that it is available in our working environment we can then include it in a workflow as we would a normal module.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Run a workflow with our new process</span>
<span class="co"># In this example we first add background points, then clip the data</span>
work6 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/workflow.html">workflow</a></span>(<span class="dt">occurrence =</span> UKAnophelesPlumbeus,
                  <span class="dt">covariate  =</span> UKAir,
                  <span class="dt">process    =</span> <span class="kw"><a href="../reference/Chain.html">Chain</a></span>(OneHundredBackground,
                                     <span class="kw">ClipOccurrence</span>(<span class="dt">extent =</span> <span class="kw">c</span>(-<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">50</span>, <span class="dv">53</span>))),
                  <span class="dt">model      =</span> LogisticRegression,
                  <span class="dt">output     =</span> PrintMap)</code></pre></div>
<p><img src="/Users/nick/Dropbox/Github/zoon/vignettes/building_pro5-1.png" title="plot of chunk building_pro5" alt="plot of chunk building_pro5" style="display:block; margin: auto"></p>
<p>We can see that the data has been clipped to the extent we specified in the map printed by the output module.</p>
<p>The next stage is to turn this function into a module which is shareable. To do this we need to add metadata to our function using the <code>BuildModule</code> function. Once <code>BuildModule</code> has created your module it will run it through checks to make sure has the required features, outputs data in the correct format, etc. Checking can be turned off by setting the argument <code>check = FALSE</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Build our module</span>
<span class="kw"><a href="../reference/BuildModule.html">BuildModule</a></span>(ClipOccurrence,
            <span class="dt">type =</span> <span class="st">'process'</span>,
            <span class="dt">title =</span> <span class="st">'Clip occurrence data to extent'</span>,
            <span class="dt">description =</span> <span class="kw">paste</span>(<span class="st">'This process module clips the occurrence'</span>,
                                <span class="st">'data that is returned from the occurrence'</span>,
                                <span class="st">'module to a user defined extent'</span>),
            <span class="dt">details =</span> <span class="kw">paste</span>(<span class="st">'The extent is a square region which denotes the'</span>,
                            <span class="st">'area within which observations will be kept.'</span>,
                            <span class="st">'All data that falls outside of the extent will'</span>,
                            <span class="st">'be removed and will be not be used in the'</span>,
                            <span class="st">'modelling process'</span>),
            <span class="dt">version =</span> <span class="fl">0.1</span>,
            <span class="dt">author =</span> <span class="st">'Z.O. Onn'</span>,
            <span class="dt">email =</span> <span class="st">'zoon@zoon-zoon.com'</span>,
            <span class="dt">paras =</span> <span class="kw">list</span>(<span class="dt">extent =</span> <span class="kw">paste</span>(<span class="st">'A numeric vector of length for'</span>,
                                        <span class="st">'giving (in this order) the minimum'</span>,
                                        <span class="st">'longitude, maximum longitude, minimum'</span>,
                                        <span class="st">'latitude, maximum latitude.'</span>)),
            <span class="dt">dataType =</span> <span class="kw">c</span>(<span class="st">'presence-only'</span>, <span class="st">'presence/absence'</span>,
                         <span class="st">'presence/background'</span>, <span class="st">'abundance'</span>,
                         <span class="st">'proportion'</span>))</code></pre></div>
<pre><code>## Starting checks...</code></pre>
<pre><code>## done</code></pre>
<pre><code>## [1] "ClipOccurrence"</code></pre>
<p>Much of how to use <code>BuildModule</code> is self-explanatory but two parameters are worth mentioning here. The <code>paras</code> argument takes a named list of the parameters the module takes. This should follow the following structure; <em>list(parameterName = &lsquo;Parameter description.&rsquo;, anotherParameter = &lsquo;Another description.&rsquo;)</em>, but should not include the defaults (i.e.&nbsp;we do not include <code>.data</code>). <code>dataType</code> describes the types of occurrence data that this module will work with. Certain modules might only work with presence-only data for example. In our case, our module will work with any type of data and so we list all the data types in the <code>dataType</code> field.</p>
<p>Once <code>BuildModule</code> has been run there will be an R file in our working directory that represents our module and can be shared with others. This R script can be used as follows.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># remove the original function from our environment</span>
<span class="kw">rm</span>(<span class="dt">list =</span> <span class="st">'ClipOccurrence'</span>)

<span class="co"># Load the module script</span>
<span class="kw"><a href="../reference/LoadModule.html">LoadModule</a></span>(<span class="st">'ClipOccurrence.R'</span>)</code></pre></div>
<pre><code>## [1] "ClipOccurrence"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">work7 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/workflow.html">workflow</a></span>(<span class="dt">occurrence =</span> AnophelesPlumbeus,
                  <span class="dt">covariate =</span> UKBioclim,
                  <span class="dt">process =</span> <span class="kw"><a href="../reference/Chain.html">Chain</a></span>(OneHundredBackground,
                                  <span class="kw">ClipOccurrence</span>(<span class="dt">extent =</span> <span class="kw">c</span>(-<span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">50</span>, <span class="dv">55</span>))),
                  <span class="dt">model =</span> LogisticRegression,
                  <span class="dt">output =</span> PrintMap)</code></pre></div>
<pre><code>## 146 records found</code></pre>
<pre><code>## 0-</code></pre>
<pre><code>## 146 records downloaded</code></pre>
<p><img src="/Users/nick/Dropbox/Github/zoon/vignettes/building_pro7-1.png" title="plot of chunk building_pro7" alt="plot of chunk building_pro7" style="display:block; margin: auto"></p>
<p>Once we&rsquo;re happy with the module, we will hopefully upload it to the zoon repository. The repository is currently under development. Visit <a href="https://zoonproject.wordpress.com/">the development pages</a> for more information.</p>
</div>
<div id="how-to-write-a-model-module" class="section level2">
<h2>How to write a model module</h2>
<p>Here is a simple function that will become our module. It is a model module that uses general additive models. We will work through it one element at a time</p>
<p>First we start our function by declaring all the parameters we need, including all the defaults</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">GamGam &lt;-<span class="st"> </span>function(.df){</code></pre></div>
<p>Since this is a model module the only default is <code>.df</code>. To find out more about defaults see the section <a href="#ModIO">Module IO definitions for module developers</a>. <code>.df</code> is a data.frame with columns: <code>values</code>, <code>type</code>, <code>fold</code>, <code>longitude</code>, <code>latitude</code> plus additional named columns giving associated covariate values. The names of the covariate columns are given as an attribute of the table: <code>attr(.df, 'covCols')]</code>.</p>
<p>Next we specify the packages our function needs. These should be specified by using <code>GetPackage</code> function in the zoon package. This function will load the package if the user of your module already has it or will install it from CRAN if they don&rsquo;t. For this reason make sure your package only uses packages that are on CRAN.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Specify the packages we need using the function</span>
<span class="co"># GetPackage</span>
zoon::<span class="kw"><a href="../reference/GetPackage.html">GetPackage</a></span>(<span class="st">"gam"</span>)</code></pre></div>
<p>Next we can add the code that does our modelling, here we create a simple GAM (Generalised Additive Model) using the package <a href="https://cran.r-project.org/package=gam">gam</a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Create a data.frame of covariate data</span>
covs &lt;-<span class="st"> </span>.df[<span class="kw">colnames</span>(.df) %in%<span class="st"> </span><span class="kw">attr</span>(.df, <span class="st">'covCols'</span>)]

<span class="co"># do a bit of copy-pasting to define smooth terms for each covariate</span>
f &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">'.df$value ~ s(%s)'</span>,
                    <span class="kw">paste</span>(<span class="kw">colnames</span>(covs),
                          <span class="dt">collapse =</span> <span class="st">') + s('</span>))

<span class="co"># Run our gam model</span>
m &lt;-<span class="st"> </span>gam::<span class="kw">gam</span>(<span class="dt">formula =</span> <span class="kw">formula</span>(f),
              <span class="dt">data =</span> covs,
              <span class="dt">family =</span> binomial)</code></pre></div>
<p>The final stage of building a model module is to write some code within the function to create a <code>ZoonModel</code> object. This is important as it standardises all outputs from model modules and crucially enables zoon to make predictions from them in a predictable and standard way.</p>
<p>We build a <code>ZoonModel</code> object by using the function <code>ZoonModel</code>. This takes three parameters</p>
<ul><li><strong><code>model</code></strong>: Your model object</li>
<li><strong><code>code</code></strong>: A section of code that will use <code>model</code> [your model] and <strong><code>newdata</code></strong> [a new set of covariate data], to return a vector of predicted values, one for each row of <code>newdata</code></li>
<li><strong><code>packages</code></strong>: A vector of characters naming the packages needed to run <code>code</code></li>
</ul><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Create a ZoonModel object to return.</span>
<span class="co"># this includes our model, predict method</span>
<span class="co"># and the packages we need.</span>
<span class="kw"><a href="../reference/ZoonModel.html">ZoonModel</a></span>(<span class="dt">model =</span> m,
          <span class="dt">code =</span> {
          
          <span class="co"># create empty vector of predictions</span>
          p &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="ot">NA</span>, <span class="kw">nrow</span>(newdata))
          
          <span class="co"># omit NAs in new data</span>
          newdata_clean &lt;-<span class="st"> </span><span class="kw">na.omit</span>(newdata)
          
          <span class="co"># get NA indices</span>
          na_idx &lt;-<span class="st"> </span><span class="kw">attr</span>(newdata_clean, <span class="st">'na.action'</span>)
          
          <span class="co"># if there are no NAs then the index should </span>
          <span class="co"># include all rows, else it should name the </span>
          <span class="co"># rows to ignore</span>
          if (<span class="kw">is.null</span>(na_idx)){
            idx &lt;-<span class="st"> </span><span class="dv">1</span>:<span class="kw">nrow</span>(newdata)
          } else {
            idx &lt;-<span class="st"> </span>-na_idx
          }
          
          <span class="co"># Use the predict function in gam to predict</span>
          <span class="co"># our new values</span>
          p[idx] &lt;-<span class="st"> </span>gam::<span class="kw">predict.gam</span>(model,
                                     newdata_clean,
                                     <span class="dt">type =</span> <span class="st">'response'</span>)
          <span class="kw">return</span> (p)
        },
        <span class="dt">packages =</span> <span class="st">'gam'</span>)</code></pre></div>
<p>With all these elements in place we now have our module complete. All together it looks like this.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">GamGam &lt;-<span class="st"> </span>function(.df){

  <span class="co"># Specify the packages we need using the function</span>
  <span class="co"># GetPackage</span>
  zoon::<span class="kw"><a href="../reference/GetPackage.html">GetPackage</a></span>(<span class="st">"gam"</span>)
  
  <span class="co"># Create a data.frame of covariate data</span>
  covs &lt;-<span class="st"> </span>.df[<span class="kw">colnames</span>(.df) %in%<span class="st"> </span><span class="kw">attr</span>(.df, <span class="st">'covCols'</span>)]

  
  <span class="co"># do a bit of copy-pasting to define smooth terms for each covariate</span>
  f &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">'.df$value ~ s(%s)'</span>,
                      <span class="kw">paste</span>(<span class="kw">colnames</span>(covs),
                            <span class="dt">collapse =</span> <span class="st">') + s('</span>))
  
  <span class="co"># Run our gam model</span>
  m &lt;-<span class="st"> </span>gam::<span class="kw">gam</span>(<span class="dt">formula =</span> <span class="kw">formula</span>(f),
                <span class="dt">data =</span> covs,
                <span class="dt">family =</span> binomial)
  
  <span class="co"># Create a ZoonModel object to return.</span>
  <span class="co"># this includes our model, predict method</span>
  <span class="co"># and the packages we need.</span>
  <span class="kw"><a href="../reference/ZoonModel.html">ZoonModel</a></span>(<span class="dt">model =</span> m,
            <span class="dt">code =</span> {
            
            <span class="co"># create empty vector of predictions</span>
            p &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="ot">NA</span>, <span class="kw">nrow</span>(newdata))
            
            <span class="co"># omit NAs in new data</span>
            newdata_clean &lt;-<span class="st"> </span><span class="kw">na.omit</span>(newdata)
            
            <span class="co"># get their indices</span>
            na_idx &lt;-<span class="st"> </span><span class="kw">attr</span>(newdata_clean, <span class="st">'na.action'</span>)
            
            <span class="co"># if there are no NAs then the index should </span>
            <span class="co"># include all rows, else it should name the </span>
            <span class="co"># rows to ignore</span>
            if (<span class="kw">is.null</span>(na_idx)){
              idx &lt;-<span class="st"> </span><span class="dv">1</span>:<span class="kw">nrow</span>(newdata)
            } else {
              idx &lt;-<span class="st"> </span>-na_idx
            }
            
            <span class="co"># Use the predict function in gam to predict</span>
            <span class="co"># our new values</span>
            p[idx] &lt;-<span class="st"> </span>gam::<span class="kw">predict.gam</span>(model,
                                       newdata_clean,
                                       <span class="dt">type =</span> <span class="st">'response'</span>)
            <span class="kw">return</span> (p)
          },
          <span class="dt">packages =</span> <span class="st">'gam'</span>)
  
}</code></pre></div>
<p>We then run <code>BuildModule</code> on our function, adding the required metadata. As this module has no parameters other than <code>.df</code> which is not user specified, we don&rsquo;t need to set the <code>paras</code> argument, which would normally be used to document arguments. Default arguments, like <code>.df</code> are all signified by starting with a <code>.</code> and don&rsquo;t need to be documented as this will be written into the module documentation automatically. It is worth noting the <code>dataType</code> field. This must be any of &lsquo;presence-only&rsquo;, &lsquo;presence/absence&rsquo;, &lsquo;presence/background&rsquo;, &lsquo;abundance&rsquo; or &lsquo;proportion&rsquo;. This is important so that people using your module in the future will know what types of data can be used as inputs. Once <code>BuildModule</code> has created your module it will run it through checks to make sure has the required features, outputs data in the correct format, etc. Checking can be turned off by setting the argument <code>check = FALSE</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/BuildModule.html">BuildModule</a></span>(<span class="dt">object =</span> GamGam,
            <span class="dt">type =</span> <span class="st">'model'</span>,
            <span class="dt">title =</span> <span class="st">'GAM sdm model'</span>,
            <span class="dt">description =</span> <span class="st">'This is my mega cool new model.'</span>,
            <span class="dt">details =</span> <span class="kw">paste</span>(<span class="st">'This module performs GAMs (Generalised Additive'</span>,
                            <span class="st">'Models) using the gam function from the package gam.'</span>),
            <span class="dt">version =</span> <span class="fl">0.1</span>,
            <span class="dt">author =</span> <span class="st">'Z. Oon'</span>,
            <span class="dt">email =</span> <span class="st">'zoon@zoon.com'</span>,
            <span class="dt">dataType =</span> <span class="kw">c</span>(<span class="st">'presence-only'</span>, <span class="st">'presence/absence'</span>))</code></pre></div>
<pre><code>## Starting checks...</code></pre>
<pre><code>## done</code></pre>
<pre><code>## [1] "GamGam"</code></pre>
<p>This is now a run-able module.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># remove the function in our workspace else</span>
<span class="co"># this will cause problems</span>
<span class="kw">rm</span>(GamGam)

<span class="co"># Load in the module we just built</span>
<span class="kw"><a href="../reference/LoadModule.html">LoadModule</a></span>(<span class="st">'GamGam.R'</span>)</code></pre></div>
<pre><code>## [1] "GamGam"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Run a workflow using our module</span>
work8 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/workflow.html">workflow</a></span>(<span class="dt">occurrence =</span> UKAnophelesPlumbeus,
                  <span class="dt">covariate =</span> UKAir,
                  <span class="dt">process  =</span> OneHundredBackground,
                  <span class="dt">model =</span> GamGam,
                  <span class="dt">output =</span> PrintMap)</code></pre></div>
<p><img src="/Users/nick/Dropbox/Github/zoon/vignettes/building_mod7-1.png" title="plot of chunk building_mod7" alt="plot of chunk building_mod7" style="display:block; margin: auto"></p>
<p>Once we&rsquo;re happy with the module, we will hopefully upload it to the zoon repository. The repository is currently under development. Visit <a href="https://zoonproject.wordpress.com/">the development pages</a> for more information.</p>
</div>
<div id="how-to-write-an-output-module" class="section level2">
<h2>How to write an output module</h2>
<p>An output module is the last module in a zoon workflow and is an opportunity to summarise the model results, make predictions, or otherwise visualise the data or results. The input to output modules is a combination of the outputs of occurrence, process and model modules providing many possible output types.</p>
<p>In this example we will create an output module that uses the model output to predict the species occurrence in a new location given by a user-provided raster.</p>
<p>When writing a module it is useful to have example input to test with. One way to do this is to run a similar workflow and use the outputs of that workflow to test yours. Here is an example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># We run a very simple workflow so that we can get example input</span>
<span class="co"># for our module</span>
work9 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/workflow.html">workflow</a></span>(<span class="dt">occurrence =</span> UKAnophelesPlumbeus,
                  <span class="dt">covariate  =</span> UKAir,
                  <span class="dt">process    =</span> OneHundredBackground,
                  <span class="dt">model      =</span> LogisticRegression,
                  <span class="dt">output     =</span> PrintMap)

<span class="co"># The input to an output module is a combination of the output</span>
<span class="co"># from the model module and the covariate module. We can recreate</span>
<span class="co"># it for this work flow like this</span>
.model &lt;-<span class="st"> </span><span class="kw"><a href="../reference/Occurrence.html">Model</a></span>(work9)
.ras &lt;-<span class="st"> </span><span class="kw"><a href="../reference/Occurrence.html">Covariate</a></span>(work9)</code></pre></div>
<p>Both <code>.model</code> and <code>.ras</code> are default arguments for an output model so it is important that you have them as arguements for your module, even if you dont use them both. It is also important that you stick to the same naming conventions.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Our output module takes the default parameters and a user-defined</span>
<span class="co"># Raster* object that has the same structure as the raster layer output</span>
<span class="co"># by the covariate module</span>
PredictNewRasterMap &lt;-<span class="st"> </span>function(.model, .ras, <span class="dt">raster =</span> .ras){</code></pre></div>
<p>It is important to have default values for all user defined parameters so that your module can be tested when you upload it to the zoon website. Here we set our default &lsquo;new area&rsquo; raster to be the same as the raster used to create the model. Clearly this is not how we envisage the module being used in a real application (unless they genuinely wanted to predict back to the same area), however this ensures that this module will always work with its default arguments, no matter what workflow it is placed in.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># The first step is to load in the packages we need</span>
zoon::<span class="kw"><a href="../reference/GetPackage.html">GetPackage</a></span>(<span class="st">"raster"</span>) 
  
<span class="co"># Then extract the covariate values</span>
<span class="co"># from the user provided raster</span>
vals &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">getValues</span>(raster))
<span class="kw">colnames</span>(vals) &lt;-<span class="st"> </span><span class="kw">names</span>(raster)</code></pre></div>
<p>Once we have these new values we can predict using the <code>ZoonPredict</code> function. This function is very useful as it simplifies the process of making predictions from the ouput of a model module. See the <a href="https://github.com/zoonproject/modules/blob/master/R/InteractiveMap.R">InteractiveMap</a> module for an innovative visualisation using predicted values.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Make predictions to the new values</span>
pred &lt;-<span class="st"> </span><span class="kw"><a href="../reference/ZoonPredict.html">ZoonPredict</a></span>(.model$model,
                    <span class="dt">newdata =</span> vals)

<span class="co"># Create a copy of the users' raster...</span>
<span class="co"># (just a single layer)</span>
pred_ras &lt;-<span class="st"> </span>raster[[<span class="dv">1</span>]]
    
<span class="co"># ... and assign the predicted values to it</span>
pred_ras &lt;-<span class="st"> </span><span class="kw">setValues</span>(pred_ras, pred)</code></pre></div>
<p>Once we have the raster of predicted values we can plot it and return the results to the user.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Plot the predictions as a map</span>
<span class="kw">plot</span>(pred_ras)

<span class="co"># Return the raster of predictions</span>
<span class="kw">return</span> (pred_ras)</code></pre></div>
<p>Our function now looks like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">PredictNewRasterMap &lt;-<span class="st"> </span>function(.model, .ras, <span class="dt">raster =</span> .ras){
  
  zoon::<span class="kw"><a href="../reference/GetPackage.html">GetPackage</a></span>(<span class="st">"raster"</span>)
  
  <span class="co"># Extract the values from the user provided raster</span>
  vals &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">getValues</span>(raster))
  <span class="kw">colnames</span>(vals) &lt;-<span class="st"> </span><span class="kw">names</span>(raster)
  
  <span class="co"># Make predictions to the new values</span>
  pred &lt;-<span class="st"> </span><span class="kw"><a href="../reference/ZoonPredict.html">ZoonPredict</a></span>(.model$model,
                      <span class="dt">newdata =</span> vals)
  
  pred_ras &lt;-<span class="st"> </span>raster[[<span class="dv">1</span>]]
  pred_ras &lt;-<span class="st"> </span><span class="kw">setValues</span>(pred_ras, pred)
  
  <span class="co"># Print the predictions as a map</span>
  <span class="kw">plot</span>(pred_ras)
  
  <span class="kw">return</span>(pred_ras)
}</code></pre></div>
<p>Our next step is to test that this function will work in a workflow. Once we have read in our function so that it is available in our working environment we can then include it in a workflow as we would a normal module.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Run it with the defaults</span>
work10 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/workflow.html">workflow</a></span>(<span class="dt">occurrence =</span> UKAnophelesPlumbeus,
                   <span class="dt">covariate  =</span> UKBioclim,
                   <span class="dt">process    =</span> OneHundredBackground,
                   <span class="dt">model      =</span> LogisticRegression,
                   <span class="dt">output     =</span> PredictNewRasterMap)</code></pre></div>
<p><img src="/Users/nick/Dropbox/Github/zoon/vignettes/building_out7-1.png" title="plot of chunk building_out7" alt="plot of chunk building_out7" style="display:block; margin: auto"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Now I'm going to run it with a different raster</span>
<span class="kw">library</span>(raster)

<span class="co"># Get Bioclim data (using the getData function in the raster package,</span>
<span class="co"># which zoon loads) ...</span>
BioclimData &lt;-<span class="st"> </span><span class="kw">getData</span>(<span class="st">'worldclim'</span>, <span class="dt">var =</span> <span class="st">'bio'</span>, <span class="dt">res =</span> <span class="dv">5</span>)
BioclimData &lt;-<span class="st"> </span>BioclimData[[<span class="dv">1</span>:<span class="dv">19</span>]]

<span class="co"># ... and crop to Australia</span>
cropped &lt;-<span class="st"> </span><span class="kw">crop</span>(BioclimData,
                <span class="kw">c</span>(<span class="dv">109</span>,<span class="dv">155</span>,-<span class="dv">46</span>,-<span class="dv">7</span>))

<span class="co"># Run it with my new raster</span>
work11 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/workflow.html">workflow</a></span>(<span class="dt">occurrence =</span> UKAnophelesPlumbeus,
                   <span class="dt">covariate  =</span> UKBioclim,
                   <span class="dt">process    =</span> OneHundredBackground,
                   <span class="dt">model      =</span> LogisticRegression,
                   <span class="dt">output     =</span> <span class="kw">PredictNewRasterMap</span>(<span class="dt">raster =</span> cropped))</code></pre></div>
<p><img src="/Users/nick/Dropbox/Github/zoon/vignettes/building_out7-2.png" title="plot of chunk building_out7" alt="plot of chunk building_out7" style="display:block; margin: auto"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># The prediction map should also be returned as a raster</span>
<span class="kw">class</span>(<span class="kw"><a href="../reference/Occurrence.html">Output</a></span>(work11))</code></pre></div>
<pre><code>## [1] "RasterLayer"
## attr(,"package")
## [1] "raster"</code></pre>
<p>The next stage is to turn this function into a module which is shareable. To do this we need to add metadata to our function using the <code>BuildModule</code> function</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Build our module</span>
<span class="kw"><a href="../reference/BuildModule.html">BuildModule</a></span>(PredictNewRasterMap,
            <span class="dt">type =</span> <span class="st">'output'</span>,
            <span class="dt">title =</span> <span class="st">'Predict to a new raster and map'</span>,
            <span class="dt">description =</span> <span class="kw">paste</span>(<span class="st">'This output module predicts the species'</span>,
                                <span class="st">'distribution in a new area given a new'</span>,
                                <span class="st">'raster'</span>),
            <span class="dt">details =</span> <span class="kw">paste</span>(<span class="st">'The results are printed as a map and a raster is'</span>,
                            <span class="st">'returned with the predicted values. It is important'</span>,
                            <span class="st">'that the new raster has the same structure as the'</span>,
                            <span class="st">'raster provided by the covariate module.'</span>,
                            <span class="st">'It must have the same covariate columns in the'</span>,
                            <span class="st">'same order.'</span>),
            <span class="dt">version =</span> <span class="fl">0.1</span>,
            <span class="dt">author =</span> <span class="st">'Z.O. On'</span>,
            <span class="dt">email =</span> <span class="st">'zoon@zoon-zoon.com'</span>,
            <span class="dt">paras =</span> <span class="kw">list</span>(<span class="dt">raster =</span> <span class="kw">paste</span>(<span class="st">'A RasterBrick, RasterLayer or RasterStack in'</span>,
                                        <span class="st">'the same format as the raster provided'</span>,
                                        <span class="st">'by the covariate module. Predicted values'</span>,
                                        <span class="st">'will be estimated for this raster using'</span>,
                                        <span class="st">'the results from the model module'</span>)),
            <span class="dt">dataType =</span> <span class="kw">c</span>(<span class="st">'presence-only'</span>, <span class="st">'presence/absence'</span>, <span class="st">'abundance'</span>,
                         <span class="st">'proportion'</span>))</code></pre></div>
<pre><code>## Starting checks...</code></pre>
<pre><code>## done</code></pre>
<pre><code>## [1] "PredictNewRasterMap"</code></pre>
<p>Once <code>BuildModule</code> has created your module it will run it through checks to make sure has the required features, outputs data in the correct format, etc. Checking can be turned off by setting the argument <code>check = FALSE</code>. Much of how to use <code>BuildModule</code> is self-explanatory but two parameters are worth mentioning here. The <code>paras</code> argument takes a named list of the parameters the module takes in the following structure: <code>list(parameterName = 'Parameter description.', anotherParameter = 'Another description.')</code>, but should not include the defaults (i.e.&nbsp;we do not include <code>.model</code> or <code>.ras</code>). <code>dataType</code> describes the types of occurrence data that this module will work with. Certain modules might only work with presence-only data for example. In our case, our module will work with any type of data and so we list all the data types in the <code>dataType</code> field.</p>
<p>Once <code>BuildModule</code> has been run there will be an R file in our working directory that represents our module and can be shared with others. This R script can be used as follows.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># remove the original function from our environment</span>
<span class="kw">rm</span>(<span class="dt">list =</span> <span class="st">'PredictNewRasterMap'</span>)

<span class="co"># Load the module script</span>
<span class="kw"><a href="../reference/LoadModule.html">LoadModule</a></span>(<span class="st">'PredictNewRasterMap.R'</span>)</code></pre></div>
<pre><code>## [1] "PredictNewRasterMap"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Now I model a crop pest from Zimbabwe in its home</span>
<span class="co"># range and in Australia by chaining together</span>
<span class="co"># output modules</span>
work12 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/workflow.html">workflow</a></span>(<span class="dt">occurrence =</span> CWBZimbabwe,
                   <span class="dt">covariate =</span> <span class="kw">Bioclim</span>(<span class="dt">extent =</span> <span class="kw">c</span>(<span class="dv">28</span>, <span class="dv">38</span>, -<span class="dv">24</span>, -<span class="dv">16</span>)),
                   <span class="dt">process =</span> NoProcess,
                   <span class="dt">model =</span> RandomForest,
                   <span class="dt">output =</span> <span class="kw"><a href="../reference/Chain.html">Chain</a></span>(PrintMap,
                                  <span class="kw">PredictNewRasterMap</span>(<span class="dt">raster =</span> cropped)))</code></pre></div>
<p><img src="/Users/nick/Dropbox/Github/zoon/vignettes/building_out9-1.png" title="plot of chunk building_out9" alt="plot of chunk building_out9" style="display:block; margin: auto"><img src="/Users/nick/Dropbox/Github/zoon/vignettes/building_out9-2.png" title="plot of chunk building_out9" alt="plot of chunk building_out9" style="display:block; margin: auto"></p>
<p>Once we&rsquo;re happy with the module, we will hopefully upload it to the zoon repository. The repository is currently under development. Visit <a href="https://zoonproject.wordpress.com/">the development pages</a> for more information. <a id="ModIO"> </a></p>
</div>
<div id="module-io-definitions-for-module-developers" class="section level2">
<h2>Module IO definitions for module developers</h2>
<p>The default input arguments and return values of modules are strict. However, any module type can have additional named input arguments, provided they have default values. A lot of the data frames include &lsquo;+ covariates&rsquo;. This indicates that the number of covariate columns is flexible. <a id="occIO"></a></p>
<div id="occurrence" class="section level3">
<h3>Occurrence</h3>
<p><em>In</em>: No default inputs</p>
<p><em>Out</em>: <code>data.frame</code> with column names (in this order):</p>
<ul><li><code>longitude</code>: The longitude of the observation.</li>
<li><code>latitude</code>: The latitude of the observation.</li>
<li><code>value</code>: The response value for the observation when used in a model. This can be 1 or 0 for presence/absence, an integer for abundance (e.g.&nbsp;1, 3, 67), or a decimal number between 0 and 1 for proportions (e.g.&nbsp;0.12, 0.5, 0.98).</li>
<li><code>type</code>: This is linked to <code>value</code> and dictates for each row of the data.frame the type of value given. This can be one of the following; <code>'presence'</code>, <code>'absence'</code>, <code>'background'</code>, <code>'abundance'</code>, <code>'proportion'</code>.</li>
<li><code>fold</code>: Folds are used to test your model. If we have, for example, 3 folds (1, 2, 3) then we can use the <a href="https://github.com/zoonproject/modules/blob/master/R/PerformanceMeasures.R"><code>PerformanceMeasures</code> output module</a> to test the performance of the model. A common method, implemented by <code>PerformanceMeasures</code> is to build the model using all but one fold, and then test the models ability to predict the fold that was held back.</li>
</ul></div>
<div id="covariate" class="section level3">
<h3>Covariate</h3>
<p><em>In</em>: No default inputs</p>
<p><em>Out</em>: <code>RasterLayer</code>, <code>RasterBrick</code> or <code>RasterStack</code> object <a id="proIO"></a></p>
</div>
<div id="process" class="section level3">
<h3>Process</h3>
<p><em>In</em>: list named <code>.data</code> with 2 named elements:</p>
<ul><li><code>df</code>: A data.frame with columns: <code>'values'</code>, <code>'type'</code>, <code>'fold'</code>, <code>'longitude'</code>, <code>'latitude'</code> plus additional names columns giving associated covariate values. See <a href="#occIO">occurrence module</a> for details on these columns. <code>df</code> has an attribute <code>covCols</code> naming the covariate columns.</li>
<li><code>ras</code>: A <code>RasterLayer</code>, <code>RasterBrick</code> or <code>RasterStack</code> object of covariate rasters</li>
</ul><p>Out: list with 2 elements</p>
<ul><li><code>df</code>: A data.frame with columns: <code>values</code>, <code>type</code>, <code>fold</code>, <code>longitude</code>, <code>latitude</code> plus additional names columns giving associated covariate values. <code>df</code> has an attribute <code>covCols</code> naming the covariate columns.</li>
<li><code>ras</code>: A <code>RasterLayer</code>, <code>RasterBrick</code> or <code>RasterStack</code> object of covariate rasters</li>
</ul></div>
<div id="model" class="section level3">
<h3>Model</h3>
<p>In: data.frame from process called <code>.df</code>. <code>.df</code> has an attribute <code>covCols</code> naming the covariate columns.</p>
<p>Out: A <code>ZoonModel</code> object (built by the function <code>ZoonModel</code>). A list with three elements.</p>
<ul><li><strong><code>model</code></strong>: Your model object</li>
<li><strong><code>code</code></strong>: A section of code that will use <code>model</code> [your model] and <strong><code>newdata</code></strong> [a new set of covariate data], to return a vector of predicted values, one for each row of <code>newdata</code></li>
<li><strong><code>packages</code></strong>: A vector of characters naming the packages needed to run <code>code</code></li>
</ul></div>
<div id="output" class="section level3">
<h3>Output</h3>
<p>In:</p>
<ul><li><p>A list named <strong><code>.model</code></strong> with 2 named elements:</p></li>
<li><code>model</code>: A <code>ZoonModel</code> object from a model module</li>
<li><p><code>data</code>: A data.frame from a process module with the added column <code>predictions</code>.<code>data</code> has an attribute <code>covCols</code> naming the covariate columns.</p></li>
<li><p>A <code>RasterLayer</code>, <code>RasterBrick</code> or <code>RasterStack</code> object named <strong><code>.ras</code></strong>, provided by the process module</p></li>
</ul><p>Out: Anything!</p>
</div>
</div>
<div id="pictoral-description-of-inputs-and-outputs" class="section level1">
<h1>Pictoral description of inputs and outputs</h1>
<p><img src="/Users/nick/Dropbox/Github/zoon/vignettes/occurrenceInOut.svg" alt="OccurrenceModule"><img src="/Users/nick/Dropbox/Github/zoon/vignettes/covariateInOut.svg" alt="CovariateModule"><img src="/Users/nick/Dropbox/Github/zoon/vignettes/processInOut.svg" alt="ProcessModule"><img src="/Users/nick/Dropbox/Github/zoon/vignettes/modelInOut.svg" alt="ModelModule"><img src="/Users/nick/Dropbox/Github/zoon/vignettes/outputInOut.svg" alt="OuputModule"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked"><li><a href="#the-1-2-3-of-module-building">The &ldquo;1, 2, 3&rdquo; of module building</a></li>
      <li><a href="#how-to-build-an-occurrence-module">How to build an occurrence module</a></li>
      <li><a href="#how-to-write-a-covariate-module">How to write a covariate module</a></li>
      <li><a href="#how-to-write-a-process-module">How to write a process module</a></li>
      <li><a href="#how-to-write-a-model-module">How to write a model module</a></li>
      <li><a href="#how-to-write-an-output-module">How to write an output module</a></li>
      <li><a href="#module-io-definitions-for-module-developers">Module IO definitions for module developers</a></li>
      <li><a href="#pictoral-description-of-inputs-and-outputs">Pictoral description of inputs and outputs</a></li>
      </ul></div>
      </div>

</div>


      <footer><p>Built by <a href="http://hadley.github.io/pkgdown/">pkgdown</a>. Styled with <a href="http://getbootstrap.com">Bootstrap 3</a>.</p>
      </footer></div>

  </body></html>
